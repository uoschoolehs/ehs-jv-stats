<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EHS JV Basketball Stats</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: radial-gradient(circle at top, #1e293b 0%, #050b18 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
      padding: 30px 20px;
      animation: fadeInDown 0.6s ease;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1 {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      color: #f8fafc;
    }
    
    h1 span {
      color: #e2b74a;
    }

    .record {
      font-size: 1.5em;
      color: #e2b74a;
      font-weight: bold;
      background: rgba(226, 183, 74, 0.1);
      display: inline-block;
      padding: 5px 20px;
      border-radius: 50px;
      border: 1px solid #e2b74a;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .record:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 20px rgba(226, 183, 74, 0.3);
    }

    .last-updated {
      font-size: 0.9em;
      color: rgba(255,255,255,0.7);
      margin-top: 10px;
    }

    .controls-wrapper {
      position: relative;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      animation: fadeIn 0.6s ease 0.2s both;
      position: relative;
      z-index: 2000;
    }

    .mobile-game-selector {
      display: none;
    }

    .scroll-indicator {
      display: none;
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      header {
        margin-bottom: 20px;
        padding: 20px 10px;
      }

      h1 {
        font-size: 1.8em;
      }

      .record {
        font-size: 1.1em;
        padding: 4px 14px;
      }

      .controls {
        flex-wrap: nowrap;
        justify-content: flex-start;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
        scroll-snap-type: x proximity;
        scrollbar-width: none;
        -ms-overflow-style: none;
        padding: 0 4px 8px;
        gap: 8px;
        margin-bottom: 10px;
      }
      
      .controls::-webkit-scrollbar {
        display: none;
      }
      
      .btn-group {
        flex-shrink: 0;
        scroll-snap-align: start;
      }
      
      .btn {
        padding: 8px 14px;
        font-size: 12px;
        white-space: nowrap;
      }

      /* Hide desktop game selector on mobile */
      .game-selector-wrapper {
        display: none !important;
      }

      /* Show mobile game selector row */
      .mobile-game-selector {
        display: none;
        justify-content: center;
        margin-bottom: 16px;
      }

      .mobile-game-selector.visible {
        display: flex;
      }
      /* Scroll indicator - simple bar */
      .scroll-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 12px;
      }

      .scroll-indicator::after {
        content: '';
        width: 40px;
        height: 4px;
        background: rgba(148, 163, 184, 0.3);
        border-radius: 2px;
      }
    }

    .btn-group {
      background: #0f172a;
      border-radius: 12px;
      padding: 5px;
      display: flex;
      gap: 5px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: border-color 0.3s;
    }

    .btn-group:hover {
      border-color: rgba(226, 183, 74, 0.3);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: #94a3b8;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(226, 183, 74, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }

    .btn:hover::before {
      width: 200px;
      height: 200px;
    }

    .btn:hover {
      background: rgba(255,255,255,0.05);
      color: #e2b74a;
    }

    .btn.active {
      background: #e2b74a;
      color: #050b18;
    }

    .btn.active::before {
      display: none;
    }

    .game-selector-wrapper {
      background: #0f172a;
      border-radius: 12px;
      padding: 5px;
      display: flex;
      align-items: center;
      position: relative;
      z-index: 1000; 
      border: 1px solid rgba(255,255,255,0.1);
    }

    .custom-select {
      position: relative;
      width: 300px;
      font-size: 14px;
      font-weight: 600;
      color: #e2b74a;
    }

    .select-trigger {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 8px;
      background: transparent;
      border: 2px solid transparent;
      transition: all 0.3s;
    }
    
    .select-trigger:hover {
      background: rgba(255,255,255,0.05);
    }

    .custom-select.open .select-trigger {
      border: 2px solid #e2b74a;
    }

    .select-options {
      position: absolute;
      display: block;
      top: 110%;
      left: 0;
      right: 0;
      background: #1e293b;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      overflow: hidden;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(-10px);
      transition: all 0.3s;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 9999;
    }

    .custom-select.open .select-options,
    .select-options.is-open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      pointer-events: auto;
    }

    .option {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      transition: background 0.2s;
      color: #f8fafc;
    }

    .option:last-child {
      border-bottom: none;
    }

    .option:hover {
      background: rgba(226, 183, 74, 0.1);
      color: #e2b74a;
    }

    .option.selected {
      background: #e2b74a;
      color: #050b18;
    }

    .arrow {
      border: solid #e2b74a;
      border-width: 0 2px 2px 0;
      display: inline-block;
      padding: 3px;
      transform: rotate(45deg);
      transition: transform 0.3s;
      margin-left: 10px;
    }

    .custom-select.open .arrow {
      transform: rotate(-135deg);
    }

    .stats-container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      overflow-x: auto;
      min-height: 400px;
      position: relative;
      z-index: 1;
      animation: fadeInUp 0.6s ease 0.3s both;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .table-wrapper {
      position: relative;
      overflow-x: auto;
    }

    .sticky-header {
      position: sticky;
      top: 0;
      background: #f8f9fa;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Mobile sticky header - keeps stat headers visible when scrolling */
    @media (max-width: 768px) {
      .table-wrapper {
        max-height: calc(100vh - 280px);
        overflow-y: auto;
        overflow-x: auto;
      }
      
      .sticky-header th {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        z-index: 10;
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f8f9fa;
    }

    th {
      padding: 15px 12px;
      text-align: left;
      font-weight: 700;
      color: #050b18;
      border-bottom: 2px solid #e2b74a;
      border-right: 1px solid #e2e8f0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s, color 0.2s;
    }

    th:last-child {
      border-right: none;
    }

    th:hover {
      background: #f1f5f9;
      color: #e2b74a;
    }

    th.sorted-desc::after {
      content: ' ‚ñº';
      font-size: 10px;
    }

    th.sorted-asc::after {
      content: ' ‚ñ≤';
      font-size: 10px;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      border-right: 1px solid #e2e8f0;
      font-size: 14px;
      transition: background 0.2s, transform 0.2s;
    }

    td:last-child {
      border-right: none;
    }

    tr {
      transition: background 0.2s, transform 0.2s;
    }

    tr:hover {
      background: #f8f9fa;
    }

    /* Stat leader highlighting */
    td.stat-leader {
      background: linear-gradient(135deg, rgba(226, 183, 74, 0.2) 0%, rgba(226, 183, 74, 0.1) 100%);
      color: #0f172a;
      font-weight: 700;
      position: relative;
    }

    /* Crown removed - keeping highlight only */

    .player-name {
      font-weight: 600;
      color: #050b18;
      cursor: pointer;
      transition: color 0.2s;
    }

    .player-name:hover {
      color: #e2b74a;
      text-decoration: underline;
    }

    .team-total-row {
      background: rgba(226, 183, 74, 0.08) !important;
      font-weight: 600;
      border-top: 1px solid rgba(226, 183, 74, 0.3);
    }

    .team-total-row td {
      color: #475569 !important;
      padding: 12px 16px !important;
      font-size: 0.9em;
    }

    .team-total-row .player-name {
      cursor: default !important;
      color: #64748b !important;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.8em;
      letter-spacing: 0.5px;
    }

    .team-total-row .player-name:hover {
      color: #64748b !important;
      text-decoration: none !important;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #e2b74a;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .game-score-display {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px dashed #e2e8f0;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }

    .score-label {
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
      margin-bottom: 10px;
      font-weight: 800;
    }

    .score-box {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #f8fafc;
      padding: 15px 40px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    .score-value {
      font-size: 2.5em;
      font-weight: 900;
      color: #1e293b;
      font-variant-numeric: tabular-nums;
    }

    .score-divider {
      margin: 0 20px;
      color: #1e293b; 
      font-size: 2.5em;
      font-weight: 900;
    }

    .score-win .score-value.primary {
      color: #22c55e;
    }

    .score-loss .score-value.primary {
      color: #ef4444;
    }

    /* Performance of the Week Section */
    .pow-section {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      color: white;
      animation: fadeIn 0.5s ease;
    }

    .pow-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .pow-title {
      font-size: 1.5em;
      color: #e2b74a;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pow-title-icon {
      font-size: 1.3em;
    }

    .week-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .week-nav-btn {
      background: rgba(226, 183, 74, 0.2);
      border: 1px solid #e2b74a;
      color: #e2b74a;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .week-nav-btn:hover {
      background: #e2b74a;
      color: #050b18;
    }

    .week-nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .week-display {
      color: #f8fafc;
      font-weight: 600;
      min-width: 180px;
      text-align: center;
    }

    .pow-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .pow-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(226, 183, 74, 0.3);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .pow-card:hover {
      transform: translateY(-4px);
      border-color: #e2b74a;
      box-shadow: 0 10px 30px rgba(226, 183, 74, 0.2);
    }

    .pow-card.winner {
      background: linear-gradient(135deg, rgba(226, 183, 74, 0.2) 0%, rgba(226, 183, 74, 0.05) 100%);
      border: 2px solid #e2b74a;
    }

    .pow-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .pow-player-name {
      font-size: 1.2em;
      font-weight: 700;
      color: #e2b74a;
    }

    .pow-gamescore {
      background: #e2b74a;
      color: #050b18;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 800;
      font-size: 0.95em;
    }

    .pow-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .pow-stat {
      text-align: center;
    }

    .pow-stat-value {
      font-size: 1.3em;
      font-weight: 700;
      color: #f8fafc;
    }

    .pow-stat-label {
      font-size: 0.75em;
      color: #94a3b8;
      text-transform: uppercase;
    }

    .pow-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #e2b74a 0%, #d4a73a 100%);
      color: #050b18;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 700;
      margin-left: 10px;
    }

    /* Most Improved Section */
    .mip-card {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(34, 197, 94, 0.05) 100%);
      border: 2px solid #22c55e;
    }

    .mip-card .pow-gamescore {
      background: #22c55e;
    }

    .mip-badge {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }

    .improvement-stat {
      color: #22c55e;
    }

    .improvement-stat.negative {
      color: #ef4444;
    }

    /* Stat Leaders Grid */
    .leaders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .leader-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s;
    }

    .leader-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border-color: #e2b74a;
    }

    .leader-category {
      font-size: 0.8em;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .leader-name {
      font-size: 1em;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 5px;
      cursor: pointer;
      transition: color 0.2s;
    }

    .leader-name:hover {
      color: #e2b74a;
    }

    .leader-value {
      font-size: 1.8em;
      font-weight: 900;
      color: #e2b74a;
    }

    .leader-crown {
      font-size: 1.5em;
      margin-bottom: 10px;
    }

    /* Player Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(5, 11, 24, 0.8);
      backdrop-filter: blur(4px);
      z-index: 5000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .player-modal {
      background: #0f172a;
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: white;
      padding: 30px;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: rgba(226, 183, 74, 0.3);
      transform: rotate(90deg);
    }

    .modal-player-name {
      font-size: 2em;
      margin-bottom: 5px;
      color: #e2b74a;
    }

    .modal-player-subtitle {
      color: rgba(255,255,255,0.7);
      font-size: 0.9em;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 5px;
    }

    .awards-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(226, 183, 74, 0.2);
      border: 2px solid #e2b74a;
      color: #e2b74a;
      padding: 8px 16px;
      border-radius: 20px;
      margin-top: 10px;
      margin-left: 10px;
      font-weight: 700;
      font-size: 0.85em;
      letter-spacing: 0.5px;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .awards-badge:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(226, 183, 74, 0.3);
    }

    .awards-badge.pow {
      background: rgba(226, 183, 74, 0.3);
      border-color: #e2b74a;
      color: #e2b74a;
    }

    .awards-badge.mip {
      background: rgba(34, 197, 94, 0.2);
      border-color: #22c55e;
      color: #22c55e;
    }

    .trophy-icon {
      font-size: 1.2em;
    }

    .modal-content {
      padding: 30px;
      background: white;
      border-radius: 0 0 16px 16px;
    }

    .modal-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .modal-btn-group {
      background: #f1f5f9;
      border-radius: 8px;
      padding: 4px;
      display: flex;
      gap: 4px;
    }

    .modal-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #64748b;
      font-weight: 600;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      font-size: 13px;
    }

    .modal-btn:hover {
      background: rgba(226, 183, 74, 0.1);
    }

    .modal-btn.active {
      background: #e2b74a;
      color: white;
    }

    .stats-section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 1.3em;
      color: #0f172a;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e2b74a;
      font-weight: 700;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #f8fafc;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #e2e8f0;
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #e2b74a;
    }

    .stat-label {
      font-size: 0.75em;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 1.8em;
      color: #0f172a;
      font-weight: 900;
    }

    .game-log-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .game-log-item {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      transition: all 0.3s;
      cursor: pointer;
      animation: fadeIn 0.3s ease;
    }

    .game-log-item:hover {
      border-color: #e2b74a;
      box-shadow: 0 4px 15px rgba(226, 183, 74, 0.2);
      transform: translateX(4px);
    }

    .game-log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .game-date {
      font-weight: 600;
      color: #0f172a;
    }

    .game-record {
      font-size: 0.85em;
      color: #64748b;
      background: white;
      padding: 4px 12px;
      border-radius: 12px;
    }

    .game-stats-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .game-stat-mini {
      font-size: 0.9em;
      color: #475569;
    }

    .game-stat-mini strong {
      color: #0f172a;
      margin-right: 4px;
    }

    .no-games {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }

    .no-stats {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .no-stats h2 {
      margin-bottom: 10px;
      color: #0f172a;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Staggered row animations */
    tbody tr {
      animation: fadeIn 0.3s ease both;
    }

    tbody tr:nth-child(1) { animation-delay: 0.05s; }
    tbody tr:nth-child(2) { animation-delay: 0.1s; }
    tbody tr:nth-child(3) { animation-delay: 0.15s; }
    tbody tr:nth-child(4) { animation-delay: 0.2s; }
    tbody tr:nth-child(5) { animation-delay: 0.25s; }
    tbody tr:nth-child(6) { animation-delay: 0.3s; }
    tbody tr:nth-child(7) { animation-delay: 0.35s; }
    tbody tr:nth-child(8) { animation-delay: 0.4s; }
    tbody tr:nth-child(9) { animation-delay: 0.45s; }
    tbody tr:nth-child(10) { animation-delay: 0.5s; }

    /* Pulse animation for POW winner */
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(226, 183, 74, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(226, 183, 74, 0); }
    }

    .pow-card.winner {
      animation: pulse 2s infinite;
    }

    @media (max-width: 768px) {
      h1 { font-size: 2em; }
      .stats-container { padding: 15px; }
      th, td { padding: 10px 8px; font-size: 12px; }
      .custom-select { width: 250px; }
      .player-modal {
        margin: 10px;
        max-height: 95vh;
      }
      .modal-header {
        padding: 20px;
      }
      .modal-content {
        padding: 20px;
      }
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
      }
      .pow-grid {
        grid-template-columns: 1fr;
      }
      .leaders-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Help Button and Modal */
    .help-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e2b74a 0%, #d4a73a 100%);
      color: #050b18;
      border: none;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(226, 183, 74, 0.4);
      transition: all 0.3s;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .help-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(226, 183, 74, 0.6);
    }

    .help-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(5, 11, 24, 0.9);
      backdrop-filter: blur(4px);
      z-index: 2000;
      overflow-y: auto;
      padding: 20px;
    }

    .help-modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .help-modal {
      background: #0f172a;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      animation: modalSlideIn 0.3s ease;
      border: 1px solid rgba(226, 183, 74, 0.3);
    }

    .help-modal-header {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: white;
      padding: 25px 30px;
      border-bottom: 1px solid rgba(226, 183, 74, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .help-modal-title {
      font-size: 1.5em;
      color: #e2b74a;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .help-modal-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .help-modal-close:hover {
      background: rgba(226, 183, 74, 0.3);
      transform: rotate(90deg);
    }

    .help-modal-content {
      padding: 30px;
      color: #f8fafc;
    }

    .help-section {
      margin-bottom: 25px;
    }

    .help-section:last-child {
      margin-bottom: 0;
    }

    .help-section-title {
      color: #e2b74a;
      font-size: 1.1em;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .help-section-content {
      color: #94a3b8;
      line-height: 1.6;
      font-size: 0.95em;
    }

    .help-section-content strong {
      color: #f8fafc;
    }

    .help-formula {
      background: rgba(226, 183, 74, 0.1);
      border: 1px solid rgba(226, 183, 74, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 0.85em;
      color: #e2b74a;
      overflow-x: auto;
    }


    .glossary-term {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .glossary-term:last-child {
      border-bottom: none;
    }

    .glossary-abbr {
      color: #e2b74a;
      font-weight: 600;
      min-width: 80px;
    }

    .glossary-def {
      color: #94a3b8;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ESSEX <span>HORNETS</span> JV BASKETBALL</h1>
      <div class="record" id="record">Loading...</div>
      <div class="last-updated" id="lastUpdated"></div>
    </header>

    <div class="controls-wrapper">
      <div class="controls">
        <div class="btn-group">
          <button class="btn active" data-view="season">Season</button>
          <button class="btn" data-view="scrimmages">Scrimmages</button>
          <button class="btn" data-view="game">Game Log</button>
          <button class="btn" data-view="leaders">Stat Leaders</button>
        </div>
        
        <div class="btn-group" id="seasonViewGroup">
          <button class="btn active" data-subview="averages">Averages</button>
          <button class="btn" data-subview="totals">Totals</button>
        </div>
        
        <div class="btn-group" id="statsTypeGroup">
          <button class="btn active" data-stats="standard">Standard</button>
          <button class="btn" data-stats="advanced">Advanced</button>
        </div>
        
        <div class="game-selector-wrapper" id="gameSelector" style="display: none;">
          <div class="custom-select" id="customGameSelect">
            <div class="select-trigger">
              <span id="selectText">Select a game...</span>
              <div class="arrow"></div>
            </div>
            <div class="select-options" id="selectOptions"></div>
          </div>
        </div>
      </div>
      
      <div class="scroll-indicator"></div>
      
      <!-- Mobile-only game selector shown below controls when Game Log is selected -->
      <div class="mobile-game-selector" id="mobileGameSelector">
        <div class="custom-select" id="mobileCustomGameSelect">
          <div class="select-trigger">
            <span id="mobileSelectText">Select a game...</span>
            <div class="arrow"></div>
          </div>
          <div class="select-options" id="mobileSelectOptions"></div>
        </div>
      </div>
    </div>

    <!-- POW Section removed - GPT awards kept in player modals -->

    <!-- Stat Leaders Section -->
    <div id="leadersSection" style="display: none;">
      <div class="leaders-grid" id="leadersGrid"></div>
    </div>

    <div class="stats-container" id="statsContainer">
      <div class="loading">
        <div class="spinner"></div>
        Loading stats...
      </div>
      
      <div class="table-wrapper">
        <table id="statsTable" style="display: none;">
          <thead id="tableHeader" class="sticky-header"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div id="scoreContainer" class="game-score-display" style="display: none;"></div>
    </div>
  </div>
  
    <!-- Disclaimers - Moved to bottom of page -->
    <div style="max-width: 1400px; margin: 30px auto 0; padding: 0 20px;">
      <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 15px; text-align: center;">
        <div style="color: #f8fafc; font-size: 0.95em; line-height: 1.6;">
          This website and statistics will <strong style="color: #e2b74a;">NOT</strong> be used to harass, bully, or shame anyone. It is only for distributing stats and making a fun competition out of the season.
        </div>
      </div>
      <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 12px; padding: 20px;">
        <div style="color: #ef4444; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1.1em;">
          <span>‚ö†Ô∏è</span> Disclaimer
        </div>
        <div style="color: #fca5a5; font-size: 0.95em; line-height: 1.6; text-align: center;">
          These statistics are <strong style="color: #f8fafc;">purely numerical</strong> and do not fully capture every player's skills, talent, overall contribution to the team, or other factors. Numbers only tell part of the story, so you shouldn't feel bad about these stats (even if someone's stats look bad, they are not a bad player).
        </div>
      </div>
    </div>

  <!-- Player Modal -->
  <div class="modal-overlay" id="playerModal">
    <div class="player-modal">
      <div class="modal-header">
        <button class="modal-close" id="modalClose">&times;</button>
        <h2 class="modal-player-name" id="modalPlayerName"></h2>
        <div class="modal-player-subtitle" id="modalPlayerSubtitle"></div>
      </div>
      <div class="modal-content">
        <div class="modal-controls">
          <div class="modal-btn-group">
            <button class="modal-btn active" data-modal-view="averages">Averages</button>
            <button class="modal-btn" data-modal-view="totals">Totals</button>
          </div>
          <div class="modal-btn-group">
            <button class="modal-btn active" data-modal-stats="standard">Standard</button>
            <button class="modal-btn" data-modal-stats="advanced">Advanced</button>
          </div>
        </div>

        <div class="stats-section">
          <h3 class="section-title">Season Statistics</h3>
          <div class="stats-grid" id="modalStatsGrid"></div>
        </div>

        <div class="stats-section">
          <h3 class="section-title">Game Log</h3>
          <div class="game-log-list" id="modalGameLog"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Button -->
  <button class="help-btn" id="helpBtn" title="Stats Glossary & Info">?</button>

  <!-- Help Modal -->
  <div class="help-modal-overlay" id="helpModal">
    <div class="help-modal">
      <div class="help-modal-header">
        <div class="help-modal-title">
          <span>üìä</span>
          Stats Glossary & Info
        </div>
        <button class="help-modal-close" id="helpModalClose">&times;</button>
      </div>
      <div class="help-modal-content">
        <div class="help-section">
          <div class="help-section-title">About the Awards</div>
          <div class="help-section-content">
            <strong>Performance of the Week (POW)</strong> is awarded to the player with the highest <strong>average GameScore</strong> for that week. If multiple games are played in a week, it's the average across all games.
            <br><br>
            <strong>Most Improved Player (MIP)</strong> goes to the player with the biggest improvement in average GameScore compared to the previous week.
          </div>
        </div>

        <div class="help-section">
          <div class="help-section-title">What is GameScore (GmSc)?</div>
          <div class="help-section-content">
            GameScore is a single stat that attempts to summarize a player's overall statistical contribution in a game
            <div class="help-formula">
              GmSc = PTS + 0.4√óFGM - 0.7√óFGA - 0.4√ó(FTA-FTM) + 0.5√óREB + STL + 0.7√óAST + 0.7√óBLK - 0.4√óPF - TO
            </div>
            <br>
            <div id="gameScoreThresholds">
              <em>GameScore thresholds will be calculated based on team data...</em>
            </div>
          </div>
        </div>

        <div class="help-section">
          <div class="help-section-title">Stat Abbreviations</div>
          <div class="help-section-content">
            <div class="glossary-term"><span class="glossary-abbr">GP</span><span class="glossary-def">Games Played</span></div>
            <div class="glossary-term"><span class="glossary-abbr">GS</span><span class="glossary-def">Games Started</span></div>
            <div class="glossary-term"><span class="glossary-abbr">PTS</span><span class="glossary-def">Points</span></div>
            <div class="glossary-term"><span class="glossary-abbr">REB</span><span class="glossary-def">Rebounds</span></div>
            <div class="glossary-term"><span class="glossary-abbr">AST</span><span class="glossary-def">Assists</span></div>
            <div class="glossary-term"><span class="glossary-abbr">STL</span><span class="glossary-def">Steals</span></div>
            <div class="glossary-term"><span class="glossary-abbr">BLK</span><span class="glossary-def">Blocks</span></div>
            <div class="glossary-term"><span class="glossary-abbr">PF</span><span class="glossary-def">Personal Fouls</span></div>
            <div class="glossary-term"><span class="glossary-abbr">TO</span><span class="glossary-def">Turnovers</span></div>
            <div class="glossary-term"><span class="glossary-abbr">FG%</span><span class="glossary-def">Field Goal Percentage</span></div>
            <div class="glossary-term"><span class="glossary-abbr">3PT%</span><span class="glossary-def">Three-Point Percentage</span></div>
            <div class="glossary-term"><span class="glossary-abbr">FT%</span><span class="glossary-def">Free Throw Percentage</span></div>
            <div class="glossary-term"><span class="glossary-abbr">eFG%</span><span class="glossary-def">Effective Field Goal %</span></div>
            <div class="glossary-term"><span class="glossary-abbr">TS%</span><span class="glossary-def">True Shooting %</span></div>
            <div class="glossary-term"><span class="glossary-abbr">AST/TO</span><span class="glossary-def">Assist to Turnover Ratio</span></div>
            <div class="glossary-term"><span class="glossary-abbr">GmSc</span><span class="glossary-def">GameScore</span></div>
          </div>
        </div>

        <div class="help-section">
          <div class="help-disclaimer">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const FIREBASE_URL = 'https://ehs-jv-stats-default-rtdb.firebaseio.com';
    const TEAM_ID = 'ehs-jv-hornets';

    let currentData = null;
    let currentView = 'season';
    let currentSubView = 'averages';
    let currentStats = 'standard';
    let currentPlayerName = null;
    let modalView = 'averages';
    let modalStats = 'standard';
    let sortState = {};
    let originalOrder = [];
    let gameLogs = [];
    let selectedGameId = null;
    let closeGameSelect = () => {};
    let scrimmageStats = null;
    let regularSeasonStats = null;
    let gptAwards = {};
    let powAwards = {};
    let mipAwards = {};
    let currentWeekIndex = 0;
    let allWeeks = [];
    let playerMetadata = {}; // Store player metadata like grade/classOf

    const COLUMN_ORDER = {
      standardAverages: ['Player', 'GP', 'PTS', 'REB', 'AST', 'STL', 'BLK', 'PF', 'TO', 'FG%', '3PT%', 'FT%'],
      standardTotals: ['Player', 'GP', 'GS', 'PTS', 'REB', 'AST', 'STL', 'BLK', 'PF', 'TO', 'FG', '3PT', 'FT'],
      advanced: ['Player', 'GP', 'PTS', 'eFG%', 'TS%', 'AST/TO'],
      scrimmageAverages: ['Player', 'GP', 'PTS', 'REB', 'AST', 'STL', 'BLK', 'PF', 'TO', 'FG%', '3PT%', 'FT%'],
      scrimmageTotals: ['Player', 'GP', 'GS', 'PTS', 'REB', 'AST', 'STL', 'BLK', 'PF', 'TO', 'FG', '3PT', 'FT'],
      gameLog: ['Player', 'PTS', 'REB', 'AST', 'STL', 'BLK', 'PF', 'TO', 'FG', '3PT', 'FT', 'GmSc']
    };

    const LEADER_CATEGORIES = ['PTS', 'REB', 'AST', 'STL', 'BLK', 'FG%', '3PT%', 'FT%', 'eFG%', 'TS%', 'AST/TO', 'TO'];

    // GameScore Formula (adapted from NBA's formula for high school)
    // GmSc = PTS + 0.4*FGM - 0.7*FGA - 0.4*(FTA-FTM) + 0.7*ORB + 0.3*DRB + STL + 0.7*AST + 0.7*BLK - 0.4*PF - TO
    // Simplified version since we don't have ORB/DRB split:
    // GmSc = PTS + 0.4*FGM - 0.7*FGA - 0.4*(FTA-FTM) + 0.5*REB + STL + 0.7*AST + 0.7*BLK - 0.4*PF - TO
    function calculateGameScore(playerStats) {
      const parseShooting = (str) => {
        if (!str || typeof str !== 'string') return { made: 0, att: 0 };
        if (str.includes('-')) {
          const [m, a] = str.split('-').map(x => parseInt(x) || 0);
          return { made: m, att: a };
        }
        return { made: 0, att: 0 };
      };

      const fg = parseShooting(playerStats.FG);
      const ft = parseShooting(playerStats.FT);
      
      const pts = parseInt(playerStats.PTS) || 0;
      const reb = parseInt(playerStats.REB) || 0;
      const ast = parseInt(playerStats.AST) || 0;
      const stl = parseInt(playerStats.STL) || 0;
      const blk = parseInt(playerStats.BLK) || 0;
      const pf = parseInt(playerStats.PF) || 0;
      const to = parseInt(playerStats.TO) || 0;

      const gmSc = pts 
        + 0.4 * fg.made 
        - 0.7 * fg.att 
        - 0.4 * (ft.att - ft.made) 
        + 0.5 * reb 
        + stl 
        + 0.7 * ast 
        + 0.7 * blk 
        - 0.4 * pf 
        - to;

      return Math.round(gmSc * 10) / 10;
    }

    // Get week boundaries (Sunday to Saturday)
    function getWeekBounds(date) {
      const d = new Date(date);
      const day = d.getDay();
      const sunday = new Date(d);
      sunday.setDate(d.getDate() - day);
      sunday.setHours(0, 0, 0, 0);
      
      const saturday = new Date(sunday);
      saturday.setDate(sunday.getDate() + 6);
      saturday.setHours(23, 59, 59, 999);
      
      return { start: sunday, end: saturday };
    }

    function formatWeekDisplay(start, end) {
      const opts = { month: 'short', day: 'numeric' };
      return `${start.toLocaleDateString('en-US', opts)} - ${end.toLocaleDateString('en-US', opts)}`;
    }

    function calculateWeeklyPerformances() {
      const weekMap = {};
      
      // Group games by week
      gameLogs.filter(g => !g.scrimmage).forEach(game => {
        const gameDate = new Date(game.date);
        const bounds = getWeekBounds(gameDate);
        const weekKey = bounds.start.toISOString();
        
        if (!weekMap[weekKey]) {
          weekMap[weekKey] = {
            start: bounds.start,
            end: bounds.end,
            games: [],
            performances: {}
          };
        }
        weekMap[weekKey].games.push(game);
      });

      // Calculate best performances per week
      Object.values(weekMap).forEach(week => {
        week.games.forEach(game => {
          game.players.forEach(player => {
            const gmSc = calculateGameScore(player);
            if (!week.performances[player.Player]) {
              week.performances[player.Player] = {
                totalGmSc: 0,
                gamesPlayed: 0,
                totalPts: 0,
                totalReb: 0,
                totalAst: 0,
                bestGame: null
              };
            }
            
            const p = week.performances[player.Player];
            p.totalGmSc += gmSc;
            p.gamesPlayed++;
            p.totalPts += parseInt(player.PTS) || 0;
            p.totalReb += parseInt(player.REB) || 0;
            p.totalAst += parseInt(player.AST) || 0;
            
            if (!p.bestGame || gmSc > p.bestGame.gmSc) {
              p.bestGame = { ...player, gmSc, gameDate: game.date };
            }
          });
        });

        // Find POW winner for this week
        let bestPlayer = null;
        let bestAvgGmSc = -Infinity;
        
        Object.entries(week.performances).forEach(([name, perf]) => {
          const avgGmSc = perf.totalGmSc / perf.gamesPlayed;
          if (avgGmSc > bestAvgGmSc) {
            bestAvgGmSc = avgGmSc;
            bestPlayer = name;
          }
        });
        
        week.powWinner = bestPlayer;
        week.powAvgGmSc = bestAvgGmSc;
      });

      // Calculate MIP (Most Improved Player) week over week
      const sortedWeeks = Object.values(weekMap).sort((a, b) => a.start - b.start);
      
      for (let i = 1; i < sortedWeeks.length; i++) {
        const prevWeek = sortedWeeks[i - 1];
        const currWeek = sortedWeeks[i];
        
        let bestImprovement = -Infinity;
        let mipPlayer = null;
        let mipData = null;
        
        Object.entries(currWeek.performances).forEach(([name, curr]) => {
          if (prevWeek.performances[name]) {
            const prev = prevWeek.performances[name];
            const prevAvg = prev.totalGmSc / prev.gamesPlayed;
            const currAvg = curr.totalGmSc / curr.gamesPlayed;
            const improvement = currAvg - prevAvg;
            
            if (improvement > bestImprovement) {
              bestImprovement = improvement;
              mipPlayer = name;
              mipData = {
                prevAvg: Math.round(prevAvg * 10) / 10,
                currAvg: Math.round(currAvg * 10) / 10,
                improvement: Math.round(improvement * 10) / 10
              };
            }
          }
        });
        
        currWeek.mipWinner = mipPlayer;
        currWeek.mipData = mipData;
      }

      allWeeks = sortedWeeks;
      currentWeekIndex = allWeeks.length - 1;
      
      // Count total awards per player
      countAwards();
    }

    function countAwards() {
      powAwards = {};
      mipAwards = {};
      
      allWeeks.forEach(week => {
        if (week.powWinner) {
          powAwards[week.powWinner] = (powAwards[week.powWinner] || 0) + 1;
        }
        if (week.mipWinner) {
          mipAwards[week.mipWinner] = (mipAwards[week.mipWinner] || 0) + 1;
        }
      });
      
      // Calculate and display GameScore thresholds based on actual team data
      updateGameScoreThresholds();
    }
    
    function updateGameScoreThresholds() {
      // Collect all individual game scores from all games
      const allGameScores = [];
      
      gameLogs.filter(g => !g.scrimmage).forEach(game => {
        game.players.forEach(player => {
          const gmSc = calculateGameScore(player);
          if (!isNaN(gmSc)) {
            allGameScores.push(gmSc);
          }
        });
      });
      
      if (allGameScores.length === 0) {
        return; // No data yet
      }
      
      // Calculate average
      const sum = allGameScores.reduce((a, b) => a + b, 0);
      const average = sum / allGameScores.length;
      
      // Sort scores to find percentiles for excellent and exceptional
      const sorted = [...allGameScores].sort((a, b) => a - b);
      
      // Excellent = 75th percentile (top 25% of performances)
      const excellentIndex = Math.floor(sorted.length * 0.75);
      const excellent = sorted[excellentIndex] || average * 1.5;
      
      // Exceptional = 90th percentile (top 10% of performances)
      const exceptionalIndex = Math.floor(sorted.length * 0.90);
      const exceptional = sorted[exceptionalIndex] || average * 2;
      
      // Round values for cleaner display
      const avgRounded = Math.round(average * 10) / 10;
      const excellentRounded = Math.round(excellent);
      const exceptionalRounded = Math.round(exceptional);
      
      // Update the help modal text
      const thresholdsEl = document.getElementById('gameScoreThresholds');
      if (thresholdsEl) {
        thresholdsEl.innerHTML = `
          <strong>For this JV team:</strong><br>
          ‚Ä¢ <strong>${avgRounded}</strong> is roughly average (team mean)<br>
          ‚Ä¢ <strong>${excellentRounded}+</strong> is excellent (top 25% of performances)<br>
          ‚Ä¢ <strong>${exceptionalRounded}+</strong> is exceptional (top 10% of performances)<br>
          <span style="font-size: 0.85em; color: #94a3b8; margin-top: 8px; display: block;">
            Based on ${allGameScores.length} individual game performances this season.
          </span>
        `;
      }
    }

    // renderPOWSection removed - awards page no longer exists

    function renderLeadersSection() {
      if (!regularSeasonStats || !regularSeasonStats.totals) {
        document.getElementById('leadersGrid').innerHTML = '<p style="color: #64748b; text-align: center; padding: 40px;">No stats available yet.</p>';
        return;
      }

      const totals = regularSeasonStats.totals;
      const averages = regularSeasonStats.averages;
      let html = '';

      const lowerIsBetter = new Set(['TO']);
      // Use totals for counting stats (PRASB + TO), averages for percentages/ratios
      const useTotals = new Set(['PTS', 'REB', 'AST', 'STL', 'BLK', 'TO']);

      const parseLeaderValue = (raw, cat) => {
        const str = String(raw ?? '').trim();
        if (!str) return null;

        if (cat === 'AST/TO') {
          if (str === '‚àû' || str.toLowerCase() === 'inf' || str.toLowerCase() === 'infinity') return Infinity;
          const n = parseFloat(str);
          return Number.isFinite(n) ? n : null;
        }

        const n = parseFloat(str.replace('%', ''));
        return Number.isFinite(n) ? n : null;
      };

      LEADER_CATEGORIES.forEach(cat => {
        const isLowerBetter = lowerIsBetter.has(cat);
        const stats = useTotals.has(cat) ? totals : averages;
        let leader = null;
        let leaderValue = isLowerBetter ? Infinity : -Infinity;

        stats.forEach(player => {
          // Skip team total from leader calculations
          if (player.Player === 'TEAM TOTAL') return;
          
          const val = parseLeaderValue(player[cat], cat);
          if (val === null) return;

          if (isLowerBetter) {
            if (val < leaderValue) {
              leaderValue = val;
              leader = player;
            }
          } else {
            if (val > leaderValue) {
              leaderValue = val;
              leader = player;
            }
          }
        });

        if (leader) {
          let displayValue = '';
          if (cat === 'AST/TO') {
            displayValue = leaderValue === Infinity ? '‚àû' : leaderValue.toFixed(2);
          } else if (cat.includes('%')) {
            displayValue = `${leaderValue.toFixed(1)}%`;
          } else if (useTotals.has(cat)) {
            displayValue = Math.round(leaderValue);
          } else {
            displayValue = leaderValue.toFixed(1);
          }

          const catLabel = cat === 'PTS' ? 'Points' : 
                          cat === 'REB' ? 'Rebounds' : 
                          cat === 'AST' ? 'Assists' : 
                          cat === 'STL' ? 'Steals' : 
                          cat === 'BLK' ? 'Blocks' :
                          cat === 'TO' ? 'Least Turnovers' :
                          cat === 'AST/TO' ? 'AST/TO Ratio' :
                          cat;

          html += `
            <div class="leader-card">
              <div class="leader-category">${catLabel}</div>
              <div class="leader-name" onclick="openPlayerModal('${leader.Player}')">${leader.Player}</div>
              <div class="leader-value">${displayValue}</div>
            </div>
          `;
        }
      });

      document.getElementById('leadersGrid').innerHTML = html;
    }

    function getStatLeaders(stats, columns) {
      const leaders = {};
      // Stats where LOWER is better (crowns go to lowest values)
      const lowerIsBetter = ['TO'];
      // Stats we do NOT crown (requested: no lowest fouls)
      const excluded = ['PF'];

      columns.forEach(col => {
        if (col === 'Player' || col === 'GP' || col === 'GS') return;
        if (excluded.includes(col)) return;

        const isLowerBetter = lowerIsBetter.includes(col);
        let bestVal = isLowerBetter ? Infinity : -Infinity;
        let leaderPlayer = null;

        stats.forEach(player => {
          // Skip team total row from leader calculations
          if (player.Player === 'TEAM TOTAL') return;
          
          let val;
          if (col === 'AST/TO') {
            const s = String(player[col] ?? '').trim();
            if (s === '‚àû' || s.toLowerCase() === 'inf' || s.toLowerCase() === 'infinity') val = Infinity;
            else {
              const n = parseFloat(s);
              val = Number.isFinite(n) ? n : NaN;
            }
          } else if (col === 'FG' || col === '3PT' || col === 'FT') {
            const match = String(player[col]).match(/^(\d+)/);
            val = match ? parseInt(match[1]) : 0;
          } else {
            const n = parseFloat(String(player[col]).replace('%', ''));
            val = Number.isFinite(n) ? n : NaN;
          }

          if (!isNaN(val)) {
            if (isLowerBetter) {
              if (val < bestVal) {
                bestVal = val;
                leaderPlayer = player.Player;
              }
            } else {
              if (val > bestVal) {
                bestVal = val;
                leaderPlayer = player.Player;
              }
            }
          }
        });

        if (leaderPlayer) {
          leaders[col] = leaderPlayer;
        }
      });

      return leaders;
    }

    function setupCustomSelect() {
      // Setup both desktop and mobile selectors
      setupSingleSelect('customGameSelect', 'selectOptions');
      setupSingleSelect('mobileCustomGameSelect', 'mobileSelectOptions');
    }

    function setupSingleSelect(selectId, optionsId) {
      const customSelect = document.getElementById(selectId);
      const trigger = customSelect.querySelector('.select-trigger');
      const options = document.getElementById(optionsId);
      const originalParent = options.parentElement;

      let isOpen = false;

      const positionOptions = () => {
        const rect = trigger.getBoundingClientRect();
        options.style.position = 'fixed';
        options.style.top = `${Math.round(rect.bottom + 8)}px`;
        options.style.left = `${Math.round(rect.left)}px`;
        options.style.width = `${Math.round(rect.width)}px`;
        options.style.zIndex = '2147483647';
      };

      const open = () => {
        if (isOpen) return;
        isOpen = true;

        customSelect.classList.add('open');
        options.classList.add('is-open');

        // Move menu to <body> to escape any stacking/overflow issues
        if (options.parentElement !== document.body) {
          document.body.appendChild(options);
        }

        positionOptions();
      };

      const close = () => {
        if (!isOpen) {
          customSelect.classList.remove('open');
          options.classList.remove('is-open');
          return;
        }
        isOpen = false;

        customSelect.classList.remove('open');
        options.classList.remove('is-open');

        // Reset any inline positioning and return to original DOM position
        options.style.position = '';
        options.style.top = '';
        options.style.left = '';
        options.style.width = '';
        options.style.zIndex = '';

        if (originalParent && options.parentElement === document.body) {
          originalParent.appendChild(options);
        }
      };

      // Expose close so selectGame() can reliably close both menus
      if (selectId === 'customGameSelect') {
        closeGameSelect = () => {
          close();
          // Also close mobile selector if open
          document.getElementById('mobileCustomGameSelect')?.classList.remove('open');
          document.getElementById('mobileSelectOptions')?.classList.remove('is-open');
        };
      }

      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (isOpen) close();
        else open();
      });

      // Keep it positioned correctly on scroll/resize
      window.addEventListener('scroll', () => {
        if (isOpen) positionOptions();
      }, true);
      window.addEventListener('resize', () => {
        if (isOpen) positionOptions();
      });

      document.addEventListener('click', (e) => {
        if (!isOpen) return;
        if (trigger.contains(e.target) || options.contains(e.target)) return;
        close();
      });
    }

    async function init() {
      setupCustomSelect();
      await Promise.all([fetchStats(), loadGameLogs(), loadGPTAwards(), loadPlayerMetadata()]);
      calculateWeeklyPerformances();
      renderTable(); // Re-render after all data is loaded
    }

    async function fetchStats() {
      try {
        const response = await fetch(`${FIREBASE_URL}/teams/${TEAM_ID}.json`);
        if (!response.ok) throw new Error('Failed to fetch');
        
        const data = await response.json();
        if (data) {
          currentData = data;
          updateHeader(data);
          renderTable();
        }
      } catch (error) {
        console.error('Failed to fetch stats:', error);
        document.querySelector('.loading').innerHTML = `
          <div class="error">
            <h3>Unable to load stats</h3>
            <p>Please make sure stats have been uploaded at least once.</p>
          </div>
        `;
      }
    }

    async function loadGPTAwards() {
      try {
        const response = await fetch(`${FIREBASE_URL}/teams/${TEAM_ID}/gptAwards.json`);
        if (!response.ok) {
          gptAwards = {};
          return;
        }
        
        const awards = await response.json();
        gptAwards = awards || {};
      } catch (error) {
        console.error('Failed to load GPT awards:', error);
        gptAwards = {};
      }
    }

    async function loadPlayerMetadata() {
      try {
        const response = await fetch(`${FIREBASE_URL}/teams/${TEAM_ID}/playerMetadata.json`);
        if (!response.ok) {
          playerMetadata = {};
          return;
        }
        
        const metadata = await response.json();
        playerMetadata = metadata || {};
      } catch (error) {
        console.error('Failed to load player metadata:', error);
        playerMetadata = {};
      }
    }

    async function loadGameLogs() {
      try {
        const response = await fetch(`${FIREBASE_URL}/teams/${TEAM_ID}/gameLogs.json`);
        if (!response.ok) {
          gameLogs = [];
          updateGameSelector();
          return;
        }
        
        const logs = await response.json();
        if (!logs) {
          gameLogs = [];
          updateGameSelector();
          return;
        }

        gameLogs = Object.entries(logs)
          .map(([id, data]) => {
            const playersArray = Object.entries(data.players || {}).map(([name, stats]) => ({
              Player: name,
              ...stats
            }));

            return {
              id,
              timestamp: data.timestamp,
              date: data.date,
              record: data.record,
              score: data.score,
              scrimmage: data.scrimmage === true || data.scrimmage === 1,
              players: playersArray
            };
          })
          .sort((a, b) => a.timestamp - b.timestamp);

        let gameCount = 0;
        let scrimmageCount = 0;
        gameLogs = gameLogs.map(log => {
          if (log.scrimmage) {
            scrimmageCount++;
            return { ...log, gameNumber: scrimmageCount };
          } else {
            gameCount++;
            return { ...log, gameNumber: gameCount };
          }
        });

        updateGameSelector();
        calculateScrimmageStats();
        calculateRegularSeasonStats();
      } catch (error) {
        console.error('Failed to load game logs:', error);
        gameLogs = [];
        updateGameSelector();
      }
    }

    function updateGameSelector() {
      const optionsContainer = document.getElementById('selectOptions');
      const mobileOptionsContainer = document.getElementById('mobileSelectOptions');
      optionsContainer.innerHTML = '';
      mobileOptionsContainer.innerHTML = '';
      
      const defaultOption = document.createElement('div');
      defaultOption.className = 'option';
      if (!selectedGameId) defaultOption.classList.add('selected');
      defaultOption.textContent = 'Select a game...';
      defaultOption.addEventListener('click', () => {
        selectGame(null, 'Select a game...');
      });
      optionsContainer.appendChild(defaultOption);
      
      // Clone for mobile
      const mobileDefaultOption = defaultOption.cloneNode(true);
      mobileDefaultOption.addEventListener('click', () => {
        selectGame(null, 'Select a game...');
      });
      mobileOptionsContainer.appendChild(mobileDefaultOption);

      gameLogs.forEach((game) => {
        const dateObj = new Date(game.date);
        const formattedDate = dateObj.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        const gameType = game.scrimmage ? 'Scrimmage' : 'Game';
        const label = `${gameType} ${game.gameNumber} - ${formattedDate} - (${game.record || '0-0'})`;
        
        const option = document.createElement('div');
        option.className = 'option';
        if (selectedGameId === game.id) option.classList.add('selected');
        option.textContent = label;
        
        option.addEventListener('click', () => {
          selectGame(game.id, label);
        });
        
        optionsContainer.appendChild(option);
        
        // Clone for mobile
        const mobileOption = option.cloneNode(true);
        mobileOption.addEventListener('click', () => {
          selectGame(game.id, label);
        });
        mobileOptionsContainer.appendChild(mobileOption);
      });
    }

    function selectGame(id, label) {
      selectedGameId = id;
      document.getElementById('selectText').textContent = label;
      document.getElementById('mobileSelectText').textContent = label;
      closeGameSelect();
      
      document.querySelectorAll('.option').forEach(opt => {
        if (opt.textContent === label) opt.classList.add('selected');
        else opt.classList.remove('selected');
      });

      renderTable();
    }

    function calculateScrimmageStats() {
      const scrimmages = gameLogs.filter(g => g.scrimmage);
      if (scrimmages.length === 0) {
        scrimmageStats = null;
        return;
      }
      
      const playerTotals = {};
      scrimmages.forEach(scrimmage => {
        scrimmage.players.forEach((player, index) => {
          accumulateStats(playerTotals, player, index);
        });
      });
      
      const stats = processStats(playerTotals);
      // Note: Per user request, scrimmages are not included in team totals calculations
      // So we don't add team row for scrimmages
      scrimmageStats = stats;
    }

    function calculateRegularSeasonStats() {
      const regularGames = gameLogs.filter(g => !g.scrimmage);
      if (regularGames.length === 0) {
        regularSeasonStats = null;
        return;
      }

      const playerTotals = {};
      regularGames.forEach(game => {
        game.players.forEach((player, index) => {
          accumulateStats(playerTotals, player, index);
        });
      });
      
      const stats = processStats(playerTotals);
      const teamStats = calculateTeamStats(regularGames);
      
      // Add team totals to the stats
      if (teamStats) {
        stats.averages.push(teamStats.averages);
        stats.totals.push(teamStats.totals);
      }
      
      regularSeasonStats = stats;
    }

    function accumulateStats(totals, player, index = 0) {
      const name = player.Player;
      if (!totals[name]) {
        totals[name] = {
          Player: name, GP: 0, GS: 0, PTS: 0, REB: 0, AST: 0, STL: 0, BLK: 0, PF: 0, TO: 0,
          FGMade: 0, FGAtt: 0, '3PTMade': 0, '3PTAtt': 0, FTMade: 0, FTAtt: 0
        };
      }

      const parseShooting = (str) => {
        if (!str || typeof str !== 'string') return { made: 0, att: 0 };
        if (str.includes('-')) {
          const [m, a] = str.split('-').map(x => parseInt(x) || 0);
          return { made: m, att: a };
        }
        return { made: 0, att: 0 };
      };

      const fg = parseShooting(player.FG);
      const threeP = parseShooting(player['3PT']);
      const ft = parseShooting(player.FT);

      totals[name].GP += 1;
      if (player.GS !== undefined) totals[name].GS += parseInt(player.GS) || 0;
      else if (index < 5) totals[name].GS += 1;
      
      totals[name].PTS += parseInt(player.PTS) || 0;
      totals[name].REB += parseInt(player.REB) || 0;
      totals[name].AST += parseInt(player.AST) || 0;
      totals[name].STL += parseInt(player.STL) || 0;
      totals[name].BLK += parseInt(player.BLK) || 0;
      totals[name].PF += parseInt(player.PF) || 0;
      totals[name].TO += parseInt(player.TO) || 0;
      totals[name].FGMade += fg.made;
      totals[name].FGAtt += fg.att;
      totals[name]['3PTMade'] += threeP.made;
      totals[name]['3PTAtt'] += threeP.att;
      totals[name].FTMade += ft.made;
      totals[name].FTAtt += ft.att;
    }

    function processStats(playerTotals) {
      const averages = Object.values(playerTotals).map(p => {
        const fgPct = p.FGAtt > 0 ? (p.FGMade / p.FGAtt) : 0;
        const threePtPct = p['3PTAtt'] > 0 ? (p['3PTMade'] / p['3PTAtt']) : 0;
        const ftPct = p.FTAtt > 0 ? (p.FTMade / p.FTAtt) : 0;
        const eFG = p.FGAtt > 0 ? ((p.FGMade + 0.5 * p['3PTMade']) / p.FGAtt * 100) : 0;
        const tsDenom = 2 * (p.FGAtt + 0.44 * p.FTAtt);
        const ts = tsDenom > 0 ? (p.PTS / tsDenom * 100) : 0;
        const astTo = p.TO > 0 ? (p.AST / p.TO) : (p.AST > 0 ? 999 : 0);

        return {
          Player: p.Player,
          GP: p.GP,
          PTS: (p.PTS / p.GP).toFixed(1),
          REB: (p.REB / p.GP).toFixed(1),
          AST: (p.AST / p.GP).toFixed(1),
          STL: (p.STL / p.GP).toFixed(1),
          BLK: (p.BLK / p.GP).toFixed(1),
          PF: (p.PF / p.GP).toFixed(1),
          TO: (p.TO / p.GP).toFixed(1),
          'FG%': (fgPct * 100).toFixed(1) + '%',
          '3PT%': (threePtPct * 100).toFixed(1) + '%',
          'FT%': (ftPct * 100).toFixed(1) + '%',
          'eFG%': eFG.toFixed(1) + '%',
          'TS%': ts.toFixed(1) + '%',
          'AST/TO': astTo === 999 ? '‚àû' : astTo.toFixed(2)
        };
      });

      const totals = Object.values(playerTotals).map(p => ({
        Player: p.Player,
        GP: p.GP,
        GS: p.GS,
        PTS: p.PTS,
        REB: p.REB,
        AST: p.AST,
        STL: p.STL,
        BLK: p.BLK,
        PF: p.PF,
        TO: p.TO,
        FG: `${p.FGMade}-${p.FGAtt}`,
        '3PT': `${p['3PTMade']}-${p['3PTAtt']}`,
        FT: `${p.FTMade}-${p.FTAtt}`
      }));

      return { averages, totals };
    }

    function calculateTeamStats(games) {
      // Calculate team stats from game logs
      if (!games || games.length === 0) return null;
      
      const teamTotals = {
        Player: 'TEAM TOTAL',
        GP: games.length,
        GS: 0,
        PTS: 0,
        REB: 0,
        AST: 0,
        STL: 0,
        BLK: 0,
        PF: 0,
        TO: 0,
        FGMade: 0,
        FGAtt: 0,
        '3PTMade': 0,
        '3PTAtt': 0,
        FTMade: 0,
        FTAtt: 0
      };

      const parseShooting = (str) => {
        if (!str || typeof str !== 'string') return { made: 0, att: 0 };
        if (str.includes('-')) {
          const [m, a] = str.split('-').map(x => parseInt(x) || 0);
          return { made: m, att: a };
        }
        return { made: 0, att: 0 };
      };

      // Sum up all player stats for each game
      games.forEach(game => {
        game.players.forEach(player => {
          const fg = parseShooting(player.FG);
          const threeP = parseShooting(player['3PT']);
          const ft = parseShooting(player.FT);

          teamTotals.PTS += parseInt(player.PTS) || 0;
          teamTotals.REB += parseInt(player.REB) || 0;
          teamTotals.AST += parseInt(player.AST) || 0;
          teamTotals.STL += parseInt(player.STL) || 0;
          teamTotals.BLK += parseInt(player.BLK) || 0;
          teamTotals.PF += parseInt(player.PF) || 0;
          teamTotals.TO += parseInt(player.TO) || 0;
          teamTotals.FGMade += fg.made;
          teamTotals.FGAtt += fg.att;
          teamTotals['3PTMade'] += threeP.made;
          teamTotals['3PTAtt'] += threeP.att;
          teamTotals.FTMade += ft.made;
          teamTotals.FTAtt += ft.att;
        });
      });

      // Calculate percentages
      const fgPct = teamTotals.FGAtt > 0 ? (teamTotals.FGMade / teamTotals.FGAtt) : 0;
      const threePtPct = teamTotals['3PTAtt'] > 0 ? (teamTotals['3PTMade'] / teamTotals['3PTAtt']) : 0;
      const ftPct = teamTotals.FTAtt > 0 ? (teamTotals.FTMade / teamTotals.FTAtt) : 0;
      const eFG = teamTotals.FGAtt > 0 ? ((teamTotals.FGMade + 0.5 * teamTotals['3PTMade']) / teamTotals.FGAtt * 100) : 0;
      const tsDenom = 2 * (teamTotals.FGAtt + 0.44 * teamTotals.FTAtt);
      const ts = tsDenom > 0 ? (teamTotals.PTS / tsDenom * 100) : 0;
      const astTo = teamTotals.TO > 0 ? (teamTotals.AST / teamTotals.TO) : (teamTotals.AST > 0 ? 999 : 0);

      return {
        averages: {
          Player: 'TEAM TOTAL',
          GP: teamTotals.GP,
          PTS: (teamTotals.PTS / teamTotals.GP).toFixed(1),
          REB: (teamTotals.REB / teamTotals.GP).toFixed(1),
          AST: (teamTotals.AST / teamTotals.GP).toFixed(1),
          STL: (teamTotals.STL / teamTotals.GP).toFixed(1),
          BLK: (teamTotals.BLK / teamTotals.GP).toFixed(1),
          PF: (teamTotals.PF / teamTotals.GP).toFixed(1),
          TO: (teamTotals.TO / teamTotals.GP).toFixed(1),
          'FG%': (fgPct * 100).toFixed(1) + '%',
          '3PT%': (threePtPct * 100).toFixed(1) + '%',
          'FT%': (ftPct * 100).toFixed(1) + '%',
          'eFG%': eFG.toFixed(1) + '%',
          'TS%': ts.toFixed(1) + '%',
          'AST/TO': astTo === 999 ? '‚àû' : astTo.toFixed(2)
        },
        totals: {
          Player: 'TEAM TOTAL',
          GP: teamTotals.GP,
          GS: 0,
          PTS: teamTotals.PTS,
          REB: teamTotals.REB,
          AST: teamTotals.AST,
          STL: teamTotals.STL,
          BLK: teamTotals.BLK,
          PF: teamTotals.PF,
          TO: teamTotals.TO,
          FG: `${teamTotals.FGMade}-${teamTotals.FGAtt}`,
          '3PT': `${teamTotals['3PTMade']}-${teamTotals['3PTAtt']}`,
          FT: `${teamTotals.FTMade}-${teamTotals.FTAtt}`
        }
      };
    }

    function calculateGameTeamTotal(game) {
      // Calculate team total for a single game log
      if (!game || !game.players || game.players.length === 0) return null;

      const parseShooting = (str) => {
        if (!str || typeof str !== 'string') return { made: 0, att: 0 };
        if (str.includes('-')) {
          const [m, a] = str.split('-').map(x => parseInt(x) || 0);
          return { made: m, att: a };
        }
        return { made: 0, att: 0 };
      };

      let totalPTS = 0, totalREB = 0, totalAST = 0, totalSTL = 0, totalBLK = 0;
      let totalPF = 0, totalTO = 0;
      let totalFGMade = 0, totalFGAtt = 0;
      let total3PTMade = 0, total3PTAtt = 0;
      let totalFTMade = 0, totalFTAtt = 0;

      game.players.forEach(player => {
        const fg = parseShooting(player.FG);
        const threeP = parseShooting(player['3PT']);
        const ft = parseShooting(player.FT);

        totalPTS += parseInt(player.PTS) || 0;
        totalREB += parseInt(player.REB) || 0;
        totalAST += parseInt(player.AST) || 0;
        totalSTL += parseInt(player.STL) || 0;
        totalBLK += parseInt(player.BLK) || 0;
        totalPF += parseInt(player.PF) || 0;
        totalTO += parseInt(player.TO) || 0;
        totalFGMade += fg.made;
        totalFGAtt += fg.att;
        total3PTMade += threeP.made;
        total3PTAtt += threeP.att;
        totalFTMade += ft.made;
        totalFTAtt += ft.att;
      });

      // Calculate team GameScore
      const gmSc = totalPTS + 0.4 * totalFGMade - 0.7 * totalFGAtt - 
                   0.4 * (totalFTAtt - totalFTMade) + 0.5 * totalREB + 
                   totalSTL + 0.7 * totalAST + 0.7 * totalBLK - 
                   0.4 * totalPF - totalTO;

      return {
        Player: 'TEAM TOTAL',
        PTS: totalPTS,
        REB: totalREB,
        AST: totalAST,
        STL: totalSTL,
        BLK: totalBLK,
        PF: totalPF,
        TO: totalTO,
        FG: `${totalFGMade}-${totalFGAtt}`,
        '3PT': `${total3PTMade}-${total3PTAtt}`,
        FT: `${totalFTMade}-${totalFTAtt}`,
        GmSc: gmSc.toFixed(1)
      };
    }

    function updateHeader(data) {
      document.getElementById('record').textContent = data.record || '0-0';
      if (data.lastUpdated) {
        const date = new Date(data.lastUpdated);
        document.getElementById('lastUpdated').innerHTML = `Last updated: ${date.toLocaleString()}`;
      }
    }

    function getJerseyNumber(playerName) {
      const match = playerName.match(/#(\d+)/);
      return match ? parseInt(match[1]) : 999;
    }

    function sortByJerseyNumber(stats) {
      return [...stats].sort((a, b) => {
        // Always keep TEAM TOTAL at the end
        if (a.Player === 'TEAM TOTAL') return 1;
        if (b.Player === 'TEAM TOTAL') return -1;
        
        const numA = getJerseyNumber(a.Player || '');
        const numB = getJerseyNumber(b.Player || '');
        return numA - numB;
      });
    }

    function sortByColumn(stats, columnName, currentState) {
      const newState = currentState === 'none' ? 'desc' : 
                       currentState === 'desc' ? 'asc' : 'none';
      
      if (newState === 'none') {
        return { data: [...originalOrder], state: 'none' };
      }

      // Separate team total from regular players
      const teamRow = stats.find(s => s.Player === 'TEAM TOTAL');
      const playerStats = stats.filter(s => s.Player !== 'TEAM TOTAL');

      const sorted = [...playerStats].sort((a, b) => {
        let valA = a[columnName];
        let valB = b[columnName];

        if (currentView === 'season' && currentSubView === 'totals' && (columnName === 'FG' || columnName === '3PT' || columnName === 'FT')) {
          const parseShootingStat = (val) => {
            if (!val || typeof val !== 'string') return { made: 0, attempts: 0 };
            if (val.includes('-')) {
              const [made, attempts] = val.split('-').map(v => parseInt(v) || 0);
              return { made, attempts };
            }
            return { made: 0, attempts: 0 };
          };

          const statsA = parseShootingStat(valA);
          const statsB = parseShootingStat(valB);

          if (statsA.attempts === 0 && statsB.attempts === 0) return 0;
          if (statsA.attempts === 0) return 1;
          if (statsB.attempts === 0) return -1;

          if (statsA.made !== statsB.made) {
            return newState === 'desc' ? statsB.made - statsA.made : statsA.made - statsB.made;
          }

          return newState === 'desc' ? statsA.attempts - statsB.attempts : statsB.attempts - statsA.attempts;
        }

        const numA = parseFloat(String(valA).replace('%', ''));
        const numB = parseFloat(String(valB).replace('%', ''));

        if (!isNaN(numA) && !isNaN(numB)) {
          return newState === 'desc' ? numB - numA : numA - numB;
        }

        const strA = String(valA).toLowerCase();
        const strB = String(valB).toLowerCase();
        return newState === 'desc' ? strB.localeCompare(strA) : strA.localeCompare(strB);
      });

      // Add team row back at the end if it exists
      if (teamRow) {
        sorted.push(teamRow);
      }

      return { data: sorted, state: newState };
    }

    function renderTable() {
      const table = document.getElementById('statsTable');
      const loading = document.querySelector('.loading');
      const scoreContainer = document.getElementById('scoreContainer');
      const statsContainer = document.getElementById('statsContainer');
      const leadersSection = document.getElementById('leadersSection');
      
      scoreContainer.style.display = 'none';
      leadersSection.style.display = 'none';
      statsContainer.style.display = 'block';

      if (currentView === 'leaders') {
        statsContainer.style.display = 'none';
        leadersSection.style.display = 'block';
        renderLeadersSection();
        return;
      }
      
      if (!currentData && currentView === 'season') {
        loading.style.display = 'block';
        table.style.display = 'none';
        return;
      }

      if (currentView === 'scrimmages') {
        if (!scrimmageStats) {
          loading.innerHTML = '<div class="no-stats"><h2>No scrimmage stats</h2><p>Mark games as scrimmages in Firebase to see stats here</p></div>';
          loading.style.display = 'block';
          table.style.display = 'none';
          return;
        }
        renderStatSet(scrimmageStats, COLUMN_ORDER.scrimmageAverages, COLUMN_ORDER.scrimmageTotals);
        loading.style.display = 'none';
        table.style.display = 'table';
        return;
      }

      if (currentView === 'game') {
        if (!selectedGameId) {
          loading.innerHTML = '<div class="no-stats"><h2>Select a game</h2><p>Choose a game from the dropdown above</p></div>';
          loading.style.display = 'block';
          table.style.display = 'none';
          return;
        }

        const gameLog = gameLogs.find(g => g.id === selectedGameId);
        if (!gameLog || gameLog.players.length === 0) {
          loading.innerHTML = '<div class="no-stats"><h2>No stats for this game</h2></div>';
          loading.style.display = 'block';
          table.style.display = 'none';
          return;
        }

        if (gameLog.score) {
          scoreContainer.style.display = 'block';
          const scores = gameLog.score.split('-').map(s => parseInt(s.trim()));
          let scoreBoxClass = '';
          
          if (scores.length === 2 && !isNaN(scores[0]) && !isNaN(scores[1])) {
            if (scores[0] > scores[1]) scoreBoxClass = 'score-win';
            else if (scores[0] < scores[1]) scoreBoxClass = 'score-loss';
            
            scoreContainer.innerHTML = `
              <div class="score-label">Final Match Result</div>
              <div class="score-box ${scoreBoxClass}">
                <span class="score-value primary">${scores[0]}</span>
                <span class="score-divider">-</span>
                <span class="score-value">${scores[1]}</span>
              </div>
            `;
          } else {
            scoreContainer.innerHTML = `
               <div class="score-label">Match Result</div>
               <div class="score-box">
                 <span class="score-value primary">${gameLog.score}</span>
               </div>
            `;
          }
        }

        // Add GameScore to each player
        let stats = gameLog.players.map(p => ({
          ...p,
          GmSc: calculateGameScore(p)
        }));
        
        // Add team totals row if it's not a scrimmage
        if (!gameLog.scrimmage) {
          const teamTotals = calculateGameTeamTotal(gameLog);
          if (teamTotals) {
            stats.push(teamTotals);
          }
        }
        
        stats = sortByJerseyNumber(stats);
        originalOrder = [...stats];
        setupTableSorting(stats, COLUMN_ORDER.gameLog);
        renderTableBody(stats, COLUMN_ORDER.gameLog);
        
        loading.style.display = 'none';
        table.style.display = 'table';
        return;
      }

      if (!regularSeasonStats) {
        loading.innerHTML = '<div class="no-stats"><h2>No regular season stats</h2><p>Stats will appear here once games are logged</p></div>';
        loading.style.display = 'block';
        table.style.display = 'none';
        return;
      }

      renderStatSet(regularSeasonStats, COLUMN_ORDER.standardAverages, COLUMN_ORDER.standardTotals);
      loading.style.display = 'none';
      table.style.display = 'table';
    }

    function renderStatSet(sourceStats, avgCols, totalCols) {
      let stats;
      let selectedColumnOrder;

      if (currentStats === 'standard' && currentSubView === 'averages') {
        stats = sourceStats.averages;
        selectedColumnOrder = avgCols;
      } else if (currentStats === 'standard' && currentSubView === 'totals') {
        stats = sourceStats.totals;
        selectedColumnOrder = totalCols;
      } else if (currentStats === 'advanced') {
        stats = sourceStats.averages;
        selectedColumnOrder = COLUMN_ORDER.advanced;
      }

      stats = sortByJerseyNumber(stats);
      originalOrder = [...stats];
      setupTableSorting(stats, selectedColumnOrder);
      renderTableBody(stats, selectedColumnOrder);
    }

    function setupTableSorting(stats, columns) {
      sortState = {};
      columns.forEach(col => sortState[col] = 'none');
      
      const thead = document.getElementById('tableHeader');
      thead.innerHTML = `<tr>${columns.map(col => `<th data-column="${col}">${col}</th>`).join('')}</tr>`;

      thead.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const columnName = th.dataset.column;
          const result = sortByColumn(stats, columnName, sortState[columnName]);
          stats = result.data;
          sortState[columnName] = result.state;
          
          thead.querySelectorAll('th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
          if (result.state === 'asc') th.classList.add('sorted-asc');
          else if (result.state === 'desc') th.classList.add('sorted-desc');
          
          renderTableBody(stats, columns);
        });
      });
    }

    function renderTableBody(stats, columns) {
      const tbody = document.getElementById('tableBody');
      const leaders = getStatLeaders(stats, columns);
      
      tbody.innerHTML = stats.map(player => {
        const isTeamRow = player.Player === 'TEAM TOTAL';
        const rowClass = isTeamRow ? 'class="team-total-row"' : '';
        
        return `
        <tr ${rowClass}>
          ${columns.map((col, idx) => {
            const value = player[col];
            let className = idx === 0 ? 'player-name' : '';
            // Don't make team total row clickable
            const clickHandler = (idx === 0 && !isTeamRow) ? `onclick="openPlayerModal('${player.Player}')"` : '';
            
            // Highlight stat leaders (but not for team total row)
            if (!isTeamRow && leaders[col] === player.Player && col !== 'Player' && col !== 'GP' && col !== 'GS') {
              className += ' stat-leader';
            }
            
            return `<td class="${className}" ${clickHandler}>${value ?? 0}</td>`;
          }).join('')}
        </tr>
      `;
      }).join('');
    }

    window.openPlayerModal = function(playerName) {
      currentPlayerName = playerName;
      modalView = 'averages';
      modalStats = 'standard';
      
      // Reset modal button UI to match the reset state
      document.querySelectorAll('[data-modal-view]').forEach(b => {
        b.classList.toggle('active', b.dataset.modalView === 'averages');
      });
      document.querySelectorAll('[data-modal-stats]').forEach(b => {
        b.classList.toggle('active', b.dataset.modalStats === 'standard');
      });
      
      // Reset advanced button visibility (it may have been hidden when totals was selected)
      const advancedBtn = document.querySelector('[data-modal-stats="advanced"]');
      if (advancedBtn) {
        advancedBtn.style.display = 'block';
      }
      
      const modal = document.getElementById('playerModal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      renderPlayerModal();
    };

    function closePlayerModal() {
      const modal = document.getElementById('playerModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }

    function renderPlayerModal() {
      if (!currentPlayerName) return;

      document.getElementById('modalPlayerName').textContent = currentPlayerName;
      
      const playerGames = gameLogs.filter(g => 
        g.players.some(p => p.Player === currentPlayerName) && !g.scrimmage
      );
      
      // Count all awards for this player
      const gptCount = gptAwards[currentPlayerName] || 0;
      const powCount = powAwards[currentPlayerName] || 0;
      const mipCount = mipAwards[currentPlayerName] || 0;
      
      // Get player metadata
      const metadata = playerMetadata[currentPlayerName] || {};
      const classOf = metadata.classOf || metadata.grade;
      
      let subtitleHTML = `${playerGames.length} Games Played`;
      
      if (classOf) {
        subtitleHTML += ` <span style="color: #94a3b8;">‚Ä¢</span> <span style="color: #e2b74a;">Class of ${classOf}</span>`;
      }
      
      if (gptCount > 0) {
        const awardText = gptCount === 1 ? '1x GPT Award' : `${gptCount}x GPT Award`;
        subtitleHTML += `<div class="awards-badge"><span class="trophy-icon">üèÜ</span> ${awardText}</div>`;
      }
      
      if (powCount > 0) {
        const awardText = powCount === 1 ? '1x POW' : `${powCount}x POW`;
        subtitleHTML += `<div class="awards-badge pow"><span class="trophy-icon">‚≠ê</span> ${awardText}</div>`;
      }
      
      if (mipCount > 0) {
        const awardText = mipCount === 1 ? '1x MIP' : `${mipCount}x MIP`;
        subtitleHTML += `<div class="awards-badge mip"><span class="trophy-icon">üìà</span> ${awardText}</div>`;
      }
      
      document.getElementById('modalPlayerSubtitle').innerHTML = subtitleHTML;

      renderModalStats();
      renderModalGameLog();
    }

    function renderModalStats() {
      const statsGrid = document.getElementById('modalStatsGrid');
      
      let stats;
      if (currentView === 'scrimmages' && scrimmageStats) {
        stats = modalView === 'averages' ? scrimmageStats.averages : scrimmageStats.totals;
      } else if (regularSeasonStats) {
        stats = modalView === 'averages' ? regularSeasonStats.averages : regularSeasonStats.totals;
      } else {
        statsGrid.innerHTML = '<p class="no-games">No stats available</p>';
        return;
      }

      const playerStats = stats.find(p => p.Player === currentPlayerName);
      if (!playerStats) {
        statsGrid.innerHTML = '<p class="no-games">No stats found for this player</p>';
        return;
      }

      let displayStats = [];
      if (modalStats === 'standard') {
        if (modalView === 'averages') {
          displayStats = [
            { label: 'GP', value: playerStats.GP },
            { label: 'PPG', value: playerStats.PTS },
            { label: 'RPG', value: playerStats.REB },
            { label: 'APG', value: playerStats.AST },
            { label: 'SPG', value: playerStats.STL },
            { label: 'BPG', value: playerStats.BLK },
            { label: 'PF', value: playerStats.PF },
            { label: 'TO', value: playerStats.TO },
            { label: 'FG%', value: playerStats['FG%'] },
            { label: '3PT%', value: playerStats['3PT%'] },
            { label: 'FT%', value: playerStats['FT%'] }
          ];
        } else {
          displayStats = [
            { label: 'GP', value: playerStats.GP },
            { label: 'GS', value: playerStats.GS },
            { label: 'PTS', value: playerStats.PTS },
            { label: 'REB', value: playerStats.REB },
            { label: 'AST', value: playerStats.AST },
            { label: 'STL', value: playerStats.STL },
            { label: 'BLK', value: playerStats.BLK },
            { label: 'PF', value: playerStats.PF },
            { label: 'TO', value: playerStats.TO },
            { label: 'FG', value: playerStats.FG },
            { label: '3PT', value: playerStats['3PT'] },
            { label: 'FT', value: playerStats.FT }
          ];
        }
      } else {
        displayStats = [
          { label: 'GP', value: playerStats.GP },
          { label: 'eFG%', value: playerStats['eFG%'] },
          { label: 'TS%', value: playerStats['TS%'] },
          { label: 'AST/TO', value: playerStats['AST/TO'] }
        ];
      }

      statsGrid.innerHTML = displayStats.map(stat => `
        <div class="stat-card">
          <div class="stat-label">${stat.label}</div>
          <div class="stat-value">${stat.value}</div>
        </div>
      `).join('');
    }

    function renderModalGameLog() {
      const gameLogContainer = document.getElementById('modalGameLog');
      
      const playerGames = gameLogs.filter(g => 
        g.players.some(p => p.Player === currentPlayerName) && !g.scrimmage
      );

      if (playerGames.length === 0) {
        gameLogContainer.innerHTML = '<p class="no-games">No games played yet</p>';
        return;
      }

      gameLogContainer.innerHTML = playerGames.map(game => {
        const playerStats = game.players.find(p => p.Player === currentPlayerName);
        if (!playerStats) return '';

        const gmSc = calculateGameScore(playerStats);
        const dateObj = new Date(game.date);
        const formattedDate = dateObj.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });

        return `
          <div class="game-log-item">
            <div class="game-log-header">
              <span class="game-date">
                Game ${game.gameNumber} - ${formattedDate}
                <span style="background: #e2b74a; color: #050b18; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 8px;">GmSc: ${gmSc}</span>
              </span>
              <span class="game-record">${game.record || '0-0'}</span>
            </div>
            <div class="game-stats-row">
              <span class="game-stat-mini"><strong>PTS:</strong> ${playerStats.PTS || 0}</span>
              <span class="game-stat-mini"><strong>REB:</strong> ${playerStats.REB || 0}</span>
              <span class="game-stat-mini"><strong>AST:</strong> ${playerStats.AST || 0}</span>
              <span class="game-stat-mini"><strong>STL:</strong> ${playerStats.STL || 0}</span>
              <span class="game-stat-mini"><strong>BLK:</strong> ${playerStats.BLK || 0}</span>
              <span class="game-stat-mini"><strong>FG:</strong> ${playerStats.FG || '0-0'}</span>
              <span class="game-stat-mini"><strong>3PT:</strong> ${playerStats['3PT'] || '0-0'}</span>
              <span class="game-stat-mini"><strong>FT:</strong> ${playerStats.FT || '0-0'}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    document.querySelectorAll('.btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        const subview = btn.dataset.subview;
        const stats = btn.dataset.stats;

        if (view) {
          document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentView = view;
          
          const seasonViewGroup = document.getElementById('seasonViewGroup');
          const statsTypeGroup = document.getElementById('statsTypeGroup');
          const gameSelector = document.getElementById('gameSelector');
          
          if (view === 'game') {
            seasonViewGroup.style.display = 'none';
            statsTypeGroup.style.display = 'none';
            gameSelector.style.display = 'flex';
            document.getElementById('mobileGameSelector').classList.add('visible');
          } else if (view === 'pow' || view === 'leaders') {
            seasonViewGroup.style.display = 'none';
            statsTypeGroup.style.display = 'none';
            gameSelector.style.display = 'none';
            document.getElementById('mobileGameSelector').classList.remove('visible');
          } else {
            seasonViewGroup.style.display = 'flex';
            statsTypeGroup.style.display = 'flex';
            gameSelector.style.display = 'none';
            document.getElementById('mobileGameSelector').classList.remove('visible');
          }
        }

        if (subview) {
          document.querySelectorAll('[data-subview]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentSubView = subview;
          
          const statsButtons = document.querySelectorAll('[data-stats]');
          if (subview === 'totals') {
            statsButtons[1].style.display = 'none';
            if (currentStats === 'advanced') {
              currentStats = 'standard';
              statsButtons[0].classList.add('active');
              statsButtons[1].classList.remove('active');
            }
          } else {
            statsButtons[1].style.display = 'block';
          }
        }

        if (stats) {
          document.querySelectorAll('[data-stats]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentStats = stats;
        }

        renderTable();
      });
    });

    document.querySelectorAll('.modal-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.dataset.modalView;
        const stats = btn.dataset.modalStats;

        if (view) {
          document.querySelectorAll('[data-modal-view]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          modalView = view;
          
          const advancedBtn = document.querySelector('[data-modal-stats="advanced"]');
          if (view === 'totals') {
            advancedBtn.style.display = 'none';
            if (modalStats === 'advanced') {
              modalStats = 'standard';
              document.querySelector('[data-modal-stats="standard"]').classList.add('active');
              advancedBtn.classList.remove('active');
            }
          } else {
            advancedBtn.style.display = 'block';
          }
        }

        if (stats) {
          document.querySelectorAll('[data-modal-stats]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          modalStats = stats;
        }

        renderModalStats();
      });
    });

    // Week navigation removed - POW section no longer exists

    document.getElementById('modalClose').addEventListener('click', closePlayerModal);
    document.getElementById('playerModal').addEventListener('click', (e) => {
      if (e.target.id === 'playerModal') {
        closePlayerModal();
      }
    });

    // Help modal functionality
    document.getElementById('helpBtn').addEventListener('click', () => {
      document.getElementById('helpModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    });

    document.getElementById('helpModalClose').addEventListener('click', () => {
      document.getElementById('helpModal').classList.remove('active');
      document.body.style.overflow = '';
    });

    document.getElementById('helpModal').addEventListener('click', (e) => {
      if (e.target.id === 'helpModal') {
        document.getElementById('helpModal').classList.remove('active');
        document.body.style.overflow = '';
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      init();
    });
  </script>
</body>
</html>
